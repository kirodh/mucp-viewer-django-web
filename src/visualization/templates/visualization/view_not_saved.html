{% extends "base.html" %}
{% load static %}


{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
{% endblock %}

{% block content %}
<!-- visualization for not saved planning cases -->
<!-- Author: Kirodh Boodhraj-->

<style>
.dataframe {
    width: 100%;
    overflow-x: auto;
    max-height: 400px;      /* scrollable by default */
    overflow-y: auto;       /* vertical scroll */
    display: block;
}

.no-scroll {
    max-height: none;       /* full height */
}


  #map {
  height: 60vh;
  width: 100%;
}
</style>

<div class="container mt-4">

  <!-- Title -->
  <div class="container mt-5">
    <h1 class="mb-4">Planning Results</h1>
    <p class="lead">
        Your results are displayed below. They will not be saved. If you refresh this page, you need to rerun the planning simaulation.
    </p>
  </div>


  <br>
  <br>
<!-- load js packages -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

  <!-- Charts -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white fw-bold">
      <h4 id="graphs-title" class="mb-0">Timeseries Graphs & Costing Charts</h4>
    </div>
    <div class="card-body">
      <div class="row g-4">
        <div class="col-md-6">
          <canvas id="densityChart" height="150"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="flowChart" height="150"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="personDaysChart" height="150"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="costChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>
  <br>
  <br>

</div>



<!-- Scripts -->


<!-- data table and budgets -->
<script>
const chartData = {{ chart_data_json|safe }};
const years = {{ years_json|safe }};
const plans = {{ plans_json|safe }};
const currency = "{{ currency }}";

// Generic line chart builder
function buildLineChart(canvasId, metric, yLabel, title) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    const datasets = plans.map((plan, i) => ({
        label: plan,
        data: years.map(y => chartData[metric][y][plan]),
        borderColor: `hsl(${i*60}, 70%, 50%)`,
        backgroundColor: `hsla(${i*60}, 70%, 50%, 0.3)`,
        fill: false,
        tension: 0.3
    }));

    new Chart(ctx, {
        type: "line",
        data: { labels: years, datasets: datasets },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: title }, legend: { position: "bottom" } },
            scales: { y: { title: { display: true, text: yLabel }, beginAtZero: true } }
        }
    });
}

// Bar chart with 'optimal' highlighted
function buildBarChartWithOptimal(canvasId, metric, currency, title) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    const datasets = plans.map((plan, i) => ({
        label: plan,
        data: years.map(y => chartData[metric][y][plan]),
        backgroundColor: plan === "optimal"
            ? "rgba(0,123,255,0.7)"
            : `rgba(${i*50},150,200,0.5)`
    }));

    new Chart(ctx, {
        type: "bar",
        data: { labels: years, datasets: datasets },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: title }, legend: { position: "bottom" } },
            scales: { y: { title: { display: true, text: currency }, beginAtZero: true } }
        }
    });
}

// Cost chart: mix bars + special line for optimal
function buildCostChartMixed(canvasId, metric, currency, title) {
    const ctx = document.getElementById(canvasId).getContext("2d");

    const datasets = plans.map((plan, i) => {
        const data = years.map(y => chartData[metric][y][plan]);

        if (plan === "optimal") {
            return {
                type: "line",
                label: "Optimal",
                data: data,
                borderColor: "black",
                borderDash: [6, 6],    // dashed line
                pointStyle: "star",    // star markers
                pointRadius: 6,
                fill: false,
                tension: 0
            };
        } else {
            return {
                type: "bar",
                label: plan,
                data: data,
                backgroundColor: `rgba(${i*50},150,200,0.6)`
            };
        }
    });

    new Chart(ctx, {
        data: { labels: years, datasets: datasets },
        options: {
            responsive: true,
            plugins: { title: { display: true, text: title }, legend: { position: "bottom" } },
            scales: { y: { title: { display: true, text: currency }, beginAtZero: true } }
        }
    });
}

// Build charts
buildLineChart("densityChart", "density", "%", "Density (%)");
buildLineChart("flowChart", "flow", "m³/s", "Flow (m³/s)");
buildLineChart("personDaysChart", "person_days", "Person Days", "Person Days");
//buildBarChartWithOptimal("costChart", "cost", currency, "Cost per Year");
buildCostChartMixed("costChart", "cost", currency, "Cost per Year");
</script>


{% endblock %}
